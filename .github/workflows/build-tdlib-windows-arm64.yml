name: Build TDLib Windows ARM64

on:
  workflow_dispatch:
  workflow_call:

env:
  TDLIB_VERSION: "1.8.60"
  TDLIB_COMMIT: cb863c1600082404428f1a84e407b866b9d412a8

jobs:
  build-windows-arm64:
    # Cross-compile on x64 runner since gperf doesn't build on ARM64 via vcpkg
    runs-on: windows-latest
    steps:
      - name: Set cache key
        run: echo "CACHE_KEY=tdlib-${{ env.TDLIB_VERSION }}-windows-latest-aarch64" >> $GITHUB_ENV
      - name: Restore cache TDLib
        id: cache-tdlib-restore
        uses: actions/cache/restore@v4
        with:
          path: td/
          key: ${{ env.CACHE_KEY }}
      - name: Build TDLib for ARM64
        if: steps.cache-tdlib-restore.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout $TDLIB_COMMIT
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          git checkout 07b30b49e5136a36100a2ce644476e60d7f3ddc1
          ./bootstrap-vcpkg.bat
          # Build host tools (gperf) for x64
          ./vcpkg.exe install gperf:x64-windows
          # Build dependencies for x64 (needed for native generator tools)
          ./vcpkg.exe install openssl:x64-windows zlib:x64-windows
          # Build dependencies for ARM64
          ./vcpkg.exe install openssl:arm64-windows zlib:arm64-windows
          cd ..

          # Stage 1: Build native x64 generators and run them to produce all auto-generated source files
          mkdir build-native
          cd build-native
          cmake -A x64 -DCMAKE_TOOLCHAIN_FILE:FILEPATH=../vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows -DGPERF_EXECUTABLE=../vcpkg/installed/x64-windows/tools/gperf/gperf.exe ..
          cmake --build . --target prepare_cross_compiling --config Release
          cd ..

          # Stage 2: Cross-compile TDLib for ARM64 using pre-generated source files
          # CMAKE_SYSTEM_NAME=Windows must be set explicitly so CMake's CMakeDetermineSystem.cmake
          # enters the cross-compiling branch (otherwise, since nobody sets CMAKE_SYSTEM_NAME,
          # it defaults to host and forces CMAKE_CROSSCOMPILING=FALSE, even if passed via -D).
          # Without this, TDLib would build generators as ARM64 and fail to run them on the x64 host.
          mkdir build
          cd build
          cmake -A ARM64 -DCMAKE_INSTALL_PREFIX:PATH=../tdlib -DCMAKE_TOOLCHAIN_FILE:FILEPATH=../vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=arm64-windows -DGPERF_EXECUTABLE=../vcpkg/installed/x64-windows/tools/gperf/gperf.exe -DTD_ENABLE_JNI=OFF -DTD_ENABLE_DOTNET=OFF -DCMAKE_SYSTEM_NAME=Windows -DCMAKE_SYSTEM_PROCESSOR=ARM64 ..
          cmake --build . --target install --config Release
        shell: bash
      - name: Save cache TDLib
        uses: actions/cache/save@v4
        if: steps.cache-tdlib-restore.outputs.cache-hit != 'true'
        with:
          path: td/
          key: ${{ env.CACHE_KEY }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.CACHE_KEY }}
          path: ./td/tdlib/
          overwrite: true
